#!/bin/bash

if [ "$1" != "non-interactive" ]
  then
  	interactive="1"

	echo -n "Version: "
	read version;

	echo -n "Redirection mail? "
	read redirect_mail

  else
  	interactive="0"
fi



function download_git()
{
	if [ -d platal ]
	  then
	  	cd platal
		git fetch
		cd ..
	  else
		[ -e platal ] && rm -rf platal
		
		git clone git://git.polytechnique.org/platal.git platal
	fi
}

function regenerate()
{
	if [ $interactive -eq 0 ]
	  then
	  	echo "$2 is out of date"
		return;
	fi
	
	sed -e "s/@VERSION@/$version/" < $1 > /tmp/regenerate.step1

	if [ ! -z "$redirect_mail" ]
	  then
		sed -e "s/%MAIL:([^%]*)%/$redirect_mail/" < /tmp/regenerate.step1 > /tmp/regenerate.step2
	  else
	        sed -e "s/%MAIL:([^%]*)%/$1/" < /tmp/regenerate.step1 > /tmp/regenerate.step2
	fi

	cp /tmp/regenerate.step2 $2
}

download_git

files=`find . -name "*.in"`

OLDIFS=$IFS
IFS=':'
for input_file in `find . -name "*.in" -printf "%p$IFS"`
  do
	output_file=`echo $input_file | sed -e 's/\.in$//'`;

	if [ $input_file -nt $output_file ]
	  then
	  	regenerate $input_file $output_file
	fi
done

