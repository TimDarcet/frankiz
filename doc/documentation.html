<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
	<title>Frankiz II</title>
	<style type="text/css">
		body		{ margin: 1em }

		a.toc1		{ margin: 0 0 0 2em; display: block }
		a.toc2		{ margin: 0 0 0 4em; display: block }

		h1,h2,h3,h4,h5	{ font-variant: small-caps; font-weight: bolder }
		h1			{ font-size: 3em; margin-bottom: 1em; text-align: center }
		h2			{ font-size: 2em; margin: .67em 0 }
		h3			{ font-size: 1.5em; margin: .83em 1em }
		h4			{ font-size: 1.17em; margin: 1em 2em }
		h5			{ font-size: 1em; margin: 1.33em 0 }

		li {
			margin: .3em 0;
			text-align: justify;
		}
		
		p {
			margin: 1em 0;
			text-align: justify;
		}

		pre.program {
			margin: .5em 0;
			padding: .5em;
			color: inherit;
			background: #DDDDDD;
			border: 1px solid #888888;
		}
	</style>
</head>
<body>

<h1>Frankiz II</h1>

<p>Ce document à vocation à être un document de base pour la création du nouveau site web des élèves,
le nouveau Frankiz.</p>

<h2>Table des matières</h2>
	<a class="toc1" href="#buts">Buts</a>
	<a class="toc1" href="#skins">Système de skinnage</a>
		<a class="toc2" href="">Généralités</a>
		<a class="toc2" href="">Définition d'une skin XSL</a>
		<a class="toc2" href="">Définition d'une skin CSS</a>
	<a class="toc1" href="#structurexml">Structure d'une page XML de Frankiz</a>
		<a class="toc2" href="">Organisation d'une page</a>
		<a class="toc2" href="">Formatage du contenu</a>
		<a class="toc2" href="">Format XML</a>
	<a class="toc1" href="#regles">Quelques règles de codage des scripts PHP</a>
		<a class="toc2" href="">Commentaires</a>
		<a class="toc2" href="">Organisation d'une page</a>
		<a class="toc2" href="">Accès aux bases MySQL</a>
		<a class="toc2" href="">Méthodes GET et POST des formulaires</a>
	<a class="toc1" href="#bdd">Format de la base de données</a>
		<a class="toc2" href="">Trombino</a>
		<a class="toc2" href="">Contenu du site web</a>
		<a class="toc2" href="">Gestion des machines (dont l'arpwatch)</a>
		<a class="toc2" href="">Gestion des validations</a>
		<a class="toc2" href="">Remarque sur les champs texte des bases</a>
	<a class="toc1" href="#organisation">Organisation des fichiers du site</a>
	<a class="toc1" href="#poly">Ambivalence Frankiz/Poly</a>
	<a class="toc1" href="#droits">Gestions des droits</a>

<h2 id="buts">Buts</h2>

<p>Les principales raisons qui nous on mener à lancer le projet du nouveau site de web de frankiz sont&nbsp;:
<ul>
	<li>mise en place d'un système de skinnage sécurisé, ie. qu'il ne doit pas être possible à un développeur
	de pouvoir exécuter des commandes sur la machine hébergeant le serveur web comme c'est le cas
	actuellement avec les skins en php. Le choix c'est porté sur la génération de pages web en XML
	ensuite convertie en HTML par une transformation XSL. Les skins sont donc les fichiers de
	transformation XSL.</li>

	<li>mise en place d'un site unique sur Frankiz et Poly&nbsp;: le même site sert d'intranet élève et de page
	web externe. Cela permettra de simplifier la gestion actuellement réparti sur deux sites avec
	d'ailleurs deux chartes graphiques différentes.</li>

	<li>mise en place d'un interface d'administration complète avec un système d'authentification&nbsp;:
	administration du site web, prez/webmestre de binets, administration des section faq et xshare,
	administration du réseau (nom des machines perso, arpwatch, gestion des autorisation d'accès au
	réseau).</li>
</ul>
</p>

<h2 id="skins">Système de skinnage</h2>
	<h3>Généralités</h3>

<p>C'est l'une des parties les plus profondes du site. Les scripts php ne renvoient pas des données
formatées en HTML, mais formatées dans un format XML définit dans le fichier <code>frankiz.dtd
</code>. Ensuite on utilise une transformation XSL pour obtenir le code HTML de la page à
envoyer au client. Il est possible d'avoir plusieurs fichier XSL, donc plusieurs skins différentes.</p>

<p>Par ailleurs, toutes les skins sortant du code HTML pourrons être en plus skinnées par une feuille
de style CSS. Ainsi, les skins XSL serviront pour des skinnages très profonds du site (modification
totale de l'organisation d'une page, génération de PDF au lieu de HTML&hellip;) alors que les skins CSS
(attachée à une skin XSL) serviront au skinnage de l'apparence des pages web.</p>

	<h3>Définition d'une skin XSL</h3>

<p>Une skin XSL est contenue dans un dossier au nom de la skin dans le dossier <code>/skin/</code>
et contient les fichiers suivants&nbsp;:
<ul>
	<li><code>skin.xsl</code>&nbsp;: le fichier XSL contenant le code de transformation XML vers HTML. Il
	peut très bien inclure d'autres fichier .xsl contenus dans le dossier de la skin.</li>

	<li><code>description.xml</code>&nbsp;: décrit tous les paramètres de la skin. En plus des en-têtes
	XML, se fichier contient&nbsp;:
<pre class="program">
&lt;skin&gt;
    &lt;nom&gt;Nom de la skin&lt;/nom&gt;
    &lt;description&gt;Description de la skin&lt;/description&gt;
    &lt;parametre id="nom_parametre"&gt;
        &lt;description&gt;Usage du paramètre&lt;/description&gt;
        &lt;valeur id="un"&gt;1&lt;/valeur&gt;
        &lt;valeur id="deux"&gt;2&lt;/valeur&gt;
    &lt;/parametre&gt;
    &lt;parametre id="&hellip;"&gt;
        &hellip;
    &lt;/parametre&gt;
&lt;/skin&gt;
</pre>
	Les paramètres peuvent être récupérer dans les fichiers de skin XSL à l'aide des lignes suivantes&nbsp;:
<pre class="program">
&lt;xsl:param name="nom_parametre"/&gt;
&lt;xsl:value-of select="$nom_parametre"/&gt;
</pre>
	</li>
	<li>tous les autres fichiers spécifiques à la skin</li>
</ul>
</p>
	
	<h3>Définition d'une skin CSS</h3>

<p>Une skin CSS est contenue dans un dossier au nom de la skin dans le dossier <code>/css/</code>
et contient les fichiers suivants&nbsp;:
<ul>
	<li><code>style.css</code>&nbsp;: le fichier CSS contenant les styles à appliquer à la page web.</li>
	<li><code>description.xml</code>&nbsp;: décrit tous les paramètres de la skin. En plus des en-têtes XML,
	se fichier contient&nbsp;:
<pre class="program">
&lt;skin&gt;
    &lt;nom&gt;Nom de la skin&lt;/nom&gt;
    &lt;description&gt;Description de la skin&lt;/description&gt;
    &lt;skinxsl&gt;Nom de la skin XSL associée&lt;/skinxsl&gt;
&lt;/skin&gt;
</pre>
	</li>
</ul>
</p>

<h2 id="structurexml">Structure d'une page XML de Frankiz</h2>
	<h3>Organisation d'une page</h3>

<p>La plupart des sites webs actuels ont des pages qui contiennent une partie centrale variant selon les 
pages, une page correspondant à un fichier HTML ou PHP. Autour de cette partie centrale, on trouve un
certain nombre de cadre présent sur tout les pages. Dans Frankiz, nous appelleront ces cadres des
"modules" (par exemple, la QDJ, les statistiques, les liens relatifs à l'X&hellip;).</p>

<p>Pour des raisons simple d'organisation, le code correspondant à chaque module/page est stocké dans un
seul fichier, différent pour chaque module/page.</p>

	<h3>Formatage du contenu</h3>

<p>TODO (cf frankik.dtd pour l'instant)</p>

	<h3>Format XML</h3>

<p>L'élément de base du site web de Frankiz est "frankiz". Cet élément contient les modules et les pages
représentés par des balises "module" et "page". Voici un exemple&nbsp;:
<pre class="program">
&lt;frankiz base="http://frankiz/" css="style.css"&gt;
    &lt;module id="liens_navigation" titre="Frankiz"&gt;
        &hellip;
    &lt;/module&gt;
    &lt;module id="liens_contacts" titre="Contacts"&gt;
        &hellip;
    &lt;/module&gt;
    &lt;module id="activites" titre="Activités"&gt;
        &hellip;
    &lt;/module&gt;
    &lt;module id="qdj" titre="QDJ"&gt;
        &hellip;
    &lt;/module&gt;
    &lt;page id="accueil" titre="Frankiz : accueil"&gt;
        &hellip;
    &lt;/page&gt;
    &lt;page id="admin_binets" titre="Frankiz : gestion des binets"&gt;
        &hellip;
    &lt;/page&gt;
&lt;/frankiz&gt;
</pre>
</p>

<p>Les modules sont identifiables par leur "id" (mais pas par leur "titre" qui doit pouvoir être modifié
quand les webmestres le souhaite), ce qui permet de les afficher différemment dans une
skin XSL si on le souhaite.</p>

<p>Pour une meilleure cohérence, les modules contenant des liens doivent avoir un id qui commence par
"liens" (cela permet d'avoir un affichage par défaut des modules contenant des liens). Dans le même
ordre d'idée, les pages d'administration auront toutes un id commençant par "admin".</p>

<p>Pour l'instant, les fichiers PHP ne renvoient qu'une seule page dans l'élément frankiz. On garde
toute fois la possibilité d'envoyer plusieurs page à la fois afin par exemple de mélanger plusieurs
pages à l'affichage, ou de d'avoir un système qui permet de switcher entre plusieurs pages sans
recharger les pages. Par défaut, les skins actuelles affichent les pages les une après les autres.</p>

<h2 id="regles">Quelques règles de codage des scripts PHP</h2>

<p>Ces règles ont pour but de rendre homogène le code écrit par plusieurs personnes appartenant à
plusieurs promo qui ne se seront pas forcément c&ocirc;toyées. Le but étant bien s&ucirc;r de rendre le code du
site web facilement lisible, afin d'en assuré sa pérénité.</p>

	<h3>Commentaires</h3>
<p>Bien s&ucirc;r qu'il faut en mettre, personne ne dit le contraire. Cependant il faut aussi le faire&nbsp;! Une
méthode simple est de mettre en entête 5-6 lignes expliquant l'utilisation et le fonctionnement du
chaque fichier. Il peut être utile d'utiliser les variables CVS pour donner des informations comme
la version d'un fichier (le "$Id$") ou les logs des modifications (le "$Log$
la version d'un fichier (le "$Id: documentation.html,v 1.3 2004/11/27 16:09:48 pico Exp $") ou les logs des modifications (le "Revision 1.4  2004/11/27 22:11:47  pico
la version d'un fichier (le "$Id: documentation.html,v 1.3 2004/11/27 16:09:48 pico Exp $") ou les logs des modifications (le "Ajout doc utilisateur 'bob'
la version d'un fichier (le "$Id: documentation.html,v 1.3 2004/11/27 16:09:48 pico Exp $") ou les logs des modifications (le "
la version d'un fichier (le "$Id$") ou les logs des modifications (le "Revision 1.3  2004/11/27 16:09:48  pico
la version d'un fichier (le "$Id$") ou les logs des modifications (le "Mise à jour de la doc: Ajout de la description des différents droits donnés aux utilisateurs
la version d'un fichier (le "$Id$") ou les logs des modifications (le "
la version d'un fichier (le "$Id$") ou les logs des modifications (le "Revision 1.2  2004/11/16 18:32:33  schmurtz
la version d'un fichier (le "$Id$") ou les logs des modifications (le "Petits problemes d'interpretation de <note> et <commentaire>
la version d'un fichier (le "$Id$") ou les logs des modifications (le "
la version d'un fichier (le "$Id$") ou les logs des modifications (le "Revision 1.1  2004/10/19 22:35:51  schmurtz
la version d'un fichier (le "$Id$") ou les logs des modifications (le "Mise à jour des documentations :
la version d'un fichier (le "$Id$") ou les logs des modifications (le "- Déplacement des docs dans ./doc
la version d'un fichier (le "$Id$") ou les logs des modifications (le "- Commentage de la DTD
la version d'un fichier (le "$Id$") ou les logs des modifications (le "- Réécriture du fichier d'exemple
la version d'un fichier (le "$Id$") ou les logs des modifications (le "- Ajout d'un fichier expliquant la structure du site
la version d'un fichier (le "$Id$") ou les logs des modifications (le ""). On évite ainsi de
devoir lire et comprendre une partie du code d'un fichier pour savoir à quoi il sert (c'est encore
plus important pour les fichiers d'include).</p>

	<h3>Organisation d'une page</h3>

<p>Un script PHP se divise souvent en deux parties (sauf pour les pages qui ne sont que des
"include")&nbsp;: le traitement de la requète HTTP puis ensuite l'affichage de la page. Il ne faut pas
hésiter à faire une séparation net entre ces deux phases.</p>

<p>Une page type ressemble à ceci&nbsp;:
<pre class="program">
&lt;?php
/*
    &laquo;utilisation et fonctionnement de la page&raquo;

    $Log$
    Revision 1.4  2004/11/27 22:11:47  pico
    Ajout doc utilisateur 'bob'

    Revision 1.3  2004/11/27 16:09:48  pico
    Mise à jour de la doc: Ajout de la description des différents droits donnés aux utilisateurs

    Revision 1.2  2004/11/16 18:32:33  schmurtz
    Petits problemes d'interpretation de <note> et <commentaire>

    Revision 1.1  2004/10/19 22:35:51  schmurtz
    Mise à jour des documentations :
    - Déplacement des docs dans ./doc
    - Commentage de la DTD
    - Réécriture du fichier d'exemple
    - Ajout d'un fichier expliquant la structure du site
 
*/

// ===== Initialisation =====
require_once "../include/global.inc.php";
require_once BASE_LOCAL."/include/mesfonctions.inc.php";

// ===== Vérification de l'authentification et des droits =====
demande_authentification(AUTH_FORT);
if(!verifie_permission("admin"))
    rediriger_vers("/");

// ===== Traitement des requètes =====
if(isset($_POST['valider_le_formulaire'])) {
    ...
}

if(isset($_GET['supprimer'])) {
    ...
}

// ===== Affichage de la page =====
require "include/page_header.inc.php";
?&gt;

&lt;page id="page_id" titre="Frankiz : ma page"&gt;
    &lt;h1&gt;Ma page&lt;h1&gt;
    &lt;p&gt;Blah chombier.&lt;/p&gt;
&lt;/page&gt;

&lt;?php require_once BASE_LOCAL."/include/page_footer.inc.php" ?&gt;
</pre>
</p>

	<h3>Accès aux bases MySQL</h3>

<p>Pour éviter d'ouvrir est refermer des connections à plusieurs bases successivement, la classe DB.
Cette classe dispose en particulier des méthodes suivantes&nbsp;:
<ul>
	<li>DB($host,$base,$utilistateur,$mdp) - constructeur permattant d'initier une connexion à une base
	MySQL. En général, les objets DB ne sont uniquement construits dans un fichier d'entête global.</li>

	<li>query($requete) - exécute une requète. Ne renvoie aucun résultat.</li>

	<li>next_row() - renvoie l'entrée suivante dans le résultat de la dernière requète.</li>
</ul>
</p>

<p>Les deux utilisations les plus courantes sont&nbsp;:
<ul>
	<li>pour une requète sans résultat
<pre class="program">
$DB_web-&gt;query("DELETE FROM matable");
</pre>
	</li>

	<li>Pour une requète avec résultat
<pre class="program">
$DB_web-&gt;query("SELECT a,b,c FROM matable");
while(list($a,$b,$c) = $DB_web-&gt;query()) {
    ...
}
</pre>
		</li>
</ul>
</p>

	<h3>Méthodes GET et POST des formulaires</h3>

<p>Pour des raisons de sécurité (on évite de donner des idées au potentiel utilisateur malveillant en
lui cachant les données envoyées), et surtout pour rendre les urls visibles par l'utilisateur moins
compliquée, il est préférable d'utiliser aux maximum les envois de données par la méthode POST.
L'envoi par la méthode GET est à utiliser uniquement dans les URLs (car on ne peut alors pas faire
de POST).</p>

<p>Par ailleurs, il est utile de supprimer les paramètres GET de l'URL en effectuant une redirection
vers la même URL sans les paramètres GET afin d'éviter que l'utilisateur réitère la requète par
erreur en rechargeant la page.</p>

<h2 id="bdd">Format de la base de données</h2>
	<h3>Trombino</h3>

<pre class="program">
CREATE TABLE eleves (
	eleve_id INT UNSIGNED NOT NULL auto_increment,
    nom TINYTEXT NOT NULL,              # nom (ECHAPE)
    prenom TINYTEXT NOT NULL,           # prénom (ECHAPE)
    surnom TINYTEXT default NULL,       # surnom (ECHAPE)
    date_nais DATETIME NOT NULL,        # date de naissance
    sexe BOOL NOT NULL,                 # sexe
    piece_id VARCHAR(7) default NULL,   # casert
    section_id TINYTEXT NOT NULL,       # section sportive (à convertir en INT UNSIGNED
                                        # après la mise en prod)
    cie TINYINT NOT NULL,               # compagnie
    promo YEAR NOT NULL,                # promotion
    login VARCHAR(8) NOT NULL,          # login dsi
    mail TINYTEXT default NULL,         # adresse mail alternative à login@poly (ECHAPE)
    #photo                              # stocké dans /data/photos/«promo»/«login».(jpg|gif|png)
    #photo_orig                         # stocké dans /data/photos/«promo»orig/«login».(jpg|gif|png)
    PRIMARY KEY (eleve_id),
    KEY (piece_id)
);

CREATE TABLE sections (
    section_id INT UNSIGNED NOT NULL auto_increment,
    nom TINYTEXT NOT NULL,              # nom de la section (ECHAPE)
    existe BOOL NOT NULL default 1,     # la section existe-elle encore ?
    bar VARCHAR(7),                     # numéro de pièce du bar d'étage
    PRIMARY KEY (section_id)
);

CREATE TABLE binets (
    binet_id INT UNSIGNED NOT NULL auto_increment,
    nom TINYTEXT NOT NULL,              # nom du binet (ECHAPE)
    description TEXT NOT NULL,          # texte de description du binet (ECHAPE)
    catego_id INT UNSIGNED NOT NULL,    # id de la catégorie de binet
    exterieur BOOL NOT NULL,            # binet visible de l'extérieur
    image LONGBLOB,                     # image du binet
    format TINYTEXT,                    # format mime de l'image
    #image,                             # image du binet stockée dans
                                        # data/binets/«id».(jpg|gif|png)
                                        # (c'est pas géré comme ça pour l'instant mais
                                        # on pourrais changer)
    http TINYTEXT,                      # url vers le site web du binet ou NULL s'il n'y
                                        # a pas de site web.
    PRIMARY KEY (binet_id)
);

CREATE TABLE binets_categorie (
    catego_id INT UNSIGNED NOT NULL auto_increment,
    categorie TINYTEXT NOT NULL,        # nom de la catégorie (ECHAPE)
    PRIMARY KEY (catego_id)
);

CREATE TABLE membres (
    binet_id INT UNSIGNED NOT NULL,     # binet
    eleve_id INT UNSIGNED NOT NULL,     # élève
    remarque TINYTEXT default NULL,     # citation/remarque/poste
    PRIMARY KEY (binet_id, eleve_id)
);

CREATE TABLE pieces (
    piece_id varchar(7) NOT NULL,       # numéro de pièce
    tel varchar(4) default NULL,        # téléphone
    comment MEDIUMTEXT,                 # usage de la pièce (chambre, binet, bar, tech)
    PRIMARY KEY(piece_id)
);
</pre>
	
	<h3>Contenu du site web</h3>
	
<pre class="program">
CREATE TABLE compte_frankiz (
    eleve_id INT UNSIGNED NOT NULL,     
    skin TEXT,                          # array php sérialisé définissant la skin de l'utilisateur
    passwd VARCHAR(32) NOT NULL,        # md5 hash du mot de passe
    perms TEXT NOT NULL,                # permission sous la forme d'une liste séparée par des virgules
                                        # eg : "admin,faq,webmestre_1,prez_60"
    hash VARCHAR(32) default NULL,      # hash d'autorisation d'accès temporaire envoyé par mail
    hashstamp DATETIME default NULL,    # fin de validité du hash
    PRIMARY KEY (eleve_id)
);

CREATE TABLE parametres (
    nom VARCHAR(20) NOT NULL,           # nom du paramètre
    valeur MEDIUMTEXT NOT NULL,         # valeur associée au paramètre (ECHAPE)
    PRIMARY KEY(nom)
);

CREATE TABLE annonces (
    annonce_id INT UNSIGNED NOT NULL auto_increment,
    stamp DATETIME NOT NULL,            # date de postage
    perime DATETIME NOT NULL,           # date de fin d'affichage de l'annonce
    titre TINYTEXT NOT NULL,            # titre de l'annonce (ECHAPE)
    contenu MEDIUMTEXT NOT NULL,        # contenu de l'annonce (ECHAPE)
    #image                              # image de l'annonce : stockée sous forme de
                                        # fichier dont le nom est «affich_id».gif
    eleve_id INT UNSIGNED NOT NULL,     # auteur de l'annonce
    en_haut BOOL NOT NULL default 0,    # annonce très importante
    exterieur BOOL NOT NULL default 0,  # annonce publique accessible par tout le monde
    PRIMARY KEY (annonce_id)
);

CREATE TABLE affiches (
    affiche_id INT UNSIGNED NOT NULL auto_increment,
    stamp DATETIME NOT NULL,            # date de postage
    date DATETIME NOT NULL,             # date de l'activité
    titre TINYTEXT NOT NULL default '', # titre de l'affiche (ECHAPE)
    url TINYTEXT NOT NULL default '',   # lien vers la description de l'activité (ECHAPE)
    #image                              # image de l'affiche : stocké sous forme de fichier dont le nom
                                        # est <affich_id>.gif
    eleve_id INT UNSIGNED NOT NULL,     # auteur de l'annonce
    exterieur BOOL NOT NULL default 0,  # affiche publique accessible par tout le monde
    PRIMARY KEY (affiche_id)
);

CREATE TABLE qdj (
    qdj_id INT UNSIGNED NOT NULL auto_increment,
    date DATE NOT NULL,                 # date de la qdj
    question TINYTEXT NOT NULL,         # question (ECHAPE)
    reponse1 TINYTEXT NOT NULL,         # première réponse (ECHAPE)
    reponse2 TINYTEXT NOT NULL,         # deuxième réponse (ECHAPE)
    compte1 INT UNSIGNED NOT NULL DEFAULT 0, # votes pour la première réponse
    compte2 INT UNSIGNED NOT NULL DEFAULT 0, # votes pour la deuxième réponse
    PRIMARY KEY (date)
);

CREATE TABLE qdj_votes (
    date DATE NOT NULL,                 # date de la qdj
    eleves_id INT UNSIGNED NOT NULL,    # id du votant
    ordre INT UNSIGNED NOT NULL,        # ordre de vote à la qdj
    UNIQUE KEY eleve (date,eleves_id),
    UNIQUE KEY ordre (date,ordre)
);

CREATE TABLE faq (
    faq_id INT UNSIGNED NOT NULL default '0' auto_increment,
    parent INT UNSIGNED NOT NULL default '0', # gestion de la hiérarchie
    question TEXT NOT NULL,             # le texte de la question (ECHAPE)
    reponse TEXT NOT NULL,              # chemin relatif de la réponse (ECHAPE)
    PRIMARY KEY (faq_id)
);

CREATE TABLE xshare (
    xshare_id INT UNSIGNED NOT NULL auto_increment,
    parent INT UNSIGNED NOT NULL default '0', # gestion de la hiérarchie
    nom TINYTEXT NOT NULL,              # nom de l'entrée (logiciel ou groupe)
    description TEXT NOT NULL,          # description
    version TINYTEXT NOT NULL,          # version (uniquement pour un logiciel)
    licence TINYTEXT NOT NULL,          # type de licence (uniquement pour un logiciel)
    lien TINYTEXT NOT NULL,             # lien pour le téléchargement (uniquement pour un logiciel)
    site TINYTEXT NOT NULL,             # site de l'éditeur (uniquement pour un logiciel)
    stamp timestamp(14) NOT NULL,       # dernière modification de l'entrée
    importance INT UNSIGNED NOT NULL default '0', # permet de mettre en valeur des logiciels
    PRIMARY KEY (xshare_id)
);

CREATE TABLE sondage_question (
    sondage_id INT UNSIGNED NOT NULL,   # id du sondage
    question_num INT UNSIGNED NOT NULL, # numéro de la question dans le sondage
    question TEXT,                      # question : array php sérialisé
    PRIMARY KEY (sondage_id,question_num)
);

CREATE TABLE sondage_reponse (
    sondage_id INT UNSIGNED NOT NULL,   # id du sondage
    question_num INT UNSIGNED NOT NULL, # numéro de la question dans le sondage
    reponse TEXT,                       # réponse : array php sérialisé
    PRIMARY KEY (sondage_id,question_num)
);
</pre>
	
	<h3>Gestion des machines (dont l'arpwatch)</h3>
	
<pre class="program">
CREATE TABLE prises (
    # séparé de la pièce car il peut y avoir plusieurs prises dans une pièce
    prise_id VARCHAR(10) NOT NULL,      # numéro de la prise (format [ABCD]xxx ou x?xx-xx-xx[AC]?)
    piece_id VARCHAR(7) NOT NULL,       # numéro de la pièce : 6 chiffres + bis
    ip VARCHAR(15) NOT NULL,            # ip théorique donnée par la DSI
    type ENUM('principale','secondaire') NOT NULL default 'secondaire',
    PRIMARY KEY(ip)
);

CREATE TABLE arpwatch_log (
    mac VARCHAR(17) NOT NULL,           # adresse MAC
    ip VARCHAR(15) NOT NULL,            # adresse IP
    dns TINYTEXT NOT NULL,              # nom dns au moment de l'enregistrement
    ts DATETIME NOT NULL,               # date du premier enregistrement de cette correspondance
    traite TINYINT UNSIGNED NOT NULL    # mis à 1 pour indiquer que le problème sur cette entrée
                                        # est résolue
    comment TEXT NOT NULL,              # commentaire sur cette entrée
);

CREATE TABLE arpwatch_vendors (
    # rempli avec http://standards.ieee.org/regauth/oui/oui.txt
    debut_mac VARCHAR(8) NOT NULL,      # trois premiers octets de l'adresse mac (xx:xx:xx)
    vendor TINYTEXT NOT NULL,           # nom du vendeur de cartes ethernet (ECHAPE)
    PRIMARY KEY (debut_mac)
);

CREATE TABLE arp_comment_mac (
  mac VARCHAR(17) NOT NULL default ''   # adresse MAC auquel est associé le commentaire
  comment TEXT NOT NULL,                # commentaire
  UNIQUE KEY mac (mac)
);

CREATE TABLE valid_ip (
    eleve_id INT UNSIGNED NOT NULL,     # auteur de la demande
    raison MEDIUMTEXT NOT NULL,         # raison de la demande d'une nouvelle ip (ECHAPE)
    PRIMARY KEY(eleve_id)
);
</pre>

	<h3>Gestion des validations</h3>

<pre class="program">
CREATE TABLE valid_affiches (
    affiche_id INT UNSIGNED NOT NULL auto_increment, # différent de l'id dans la table affiches
    stamp TIMESTAMP NOT NULL,
    date DATETIME NOT NULL,
    titre TINYTEXT NOT NULL,
    url TINYTEXT NOT NULL,
    eleve_id INT UNSIGNED NOT NULL,
    exterieur BOOL NOT NULL default '0',
    PRIMARY KEY (affiche_id)
);

CREATE TABLE valid_annonces (
    annonce_id INT UNSIGNED NOT NULL auto_increment,
    stamp TIMESTAMP NOT NULL,
    perime DATETIME NOT NULL,
    titre TINYTEXT NOT NULL,
    contenu MEDIUMTEXT NOT NULL,
    eleve_id INT UNSIGNED NOT NULL,
    exterieur BOOL NOT NULL default 0,
    PRIMARY KEY (annonce_id)
);

CREATE TABLE valid_mailpromo (
    mail_id INT UNSIGNED NOT NULL auto_increment,
    eleve_id INT UNSIGNED NOT NULL,     # élève faisant la demande de mail promo
    promo TINYTEXT NOT NULL,            # promos visées par le mail
    titre TINYTEXT NOT NULL,            # objet du mail
    mail TEXT NOT NULL,                 # contenu du mail
    stamp TIMESTAMP NOT NULL,           # date de la demande
    PRIMARY KEY (mail_id)
);

CREATE TABLE valid_qdj (
    qdj_id INT UNSIGNED NOT NULL auto_increment,
    eleve_id INT UNSIGNED NOT NULL,     # auteur de la proposition
    question TINYTEXT NOT NULL,
    reponse1 TINYTEXT NOT NULL,
    reponse2 TINYTEXT NOT NULL,
    stamp TIMESTAMP NOT NULL,           # date de la proposition
    PRIMARY KEY (qdj_id)
);
</pre>

	<h3>Remarque sur les champs texte des bases</h3>

<p>Les champs contenant du texte peuvent contenir quasiment n'importe quoi, dont des balises XML.
Il est donc important d'en tenir compte et de supprimer toutes ces balises, ou de la convertir avec
des &amp;lt; et &amp;gt; afin que le XML ne puisse pas être rendu invalide par l'action de
l'utilisateur. Idem pour le caractère &amp; qui doit être converti en &amp;amp;.</p>

<p>Par ailleurs, afin d'empécher des attaques du genre "injection SQL ou HTML", les données récupérées
par les méthode GET, POST et les COOKIES sont toutes automatiquement traitées pour échapper avec des
&amp;&hellip;; les cinq caractères spéciaux du XML : &lt;, &gt;, &apos;, &quote; et &amp;. C'est sous
cette forme que sont stockées les cha&icirc;nes de caractères dans les tables MySQL. Il n'est d'ailleurs
pas utile (et même deconseillé) de les dééchapper avant de les afficher dans la page web.</p>

<h2 id="organisation">Organisation des fichiers du site</h2>

<p>À la racine du dossier contenant les données du site web, on trouve un dossier /public_html/
contenant les fichiers accessibles par apache (uniquement les fichiers de la CVS, pas de fichier
rajouté par des scripts PHP). On y trouve aussi les dossiers /etc/, /cache/, /data/
contenant respectivement, les fichiers de conf d'apache pour le site web de frankiz, les fichiers de
cache servant à limiter les appels à la base de données, les données non stockées dans la base MySQL
comme les images des annonces ou les photos du trombino.</p>

<p>Dans le dossier /public_html/, on trouve les dossiers /public_html/modules/, /public_html/includes/,
/public_html/skins/ contenant respectivement les scripts PHP des modules, les fichiers PHP qui ne
sont pas accédés directement par Apache (ceux qui ne sont qu'inclus par d'autre, portant en général
l'extension .inc.php), les skins XSL. Tous les autres fichiers correspondent à une page (au sens de
l'élément "page" du format XML).</p>

<p>Afin de conserve une hiérarchie lisible, il faut éviter de créer trop de dossiers et d'avoir une
répartition du nombre de fichiers assez homogène dans tous les dossiers, je pense qu'un seul niveau
de dossier serait suffisant vu que notre site n'est pas si grand que ça.</p>

<p>On obtient alors la hiérarchie suivante&nbsp;:
<pre class="program">
/bin                (DOSSIER PRÉSENT DANS LA CVS)
	...             (des scripts utiliser pour la gestion du site web, par
					exemple pour les stats)

/cache              (DOSSIER INEXISTANT DANS LA CVS)

/data               (DOSSIER INEXISTANT DANS LA CVS)
    /photos         (photo du trombino)
        /2002
            &laquo;login&raquo;.jpg
        /2002orig
        /2003
        /2003orig
    /annonces       (images des annonces Frankiz)
        &laquo;id&raquo;.jpg
    /activites
        &laquo;id&raquo;.jpg    (affiche des activités comme le BRC)
    /binets
        &laquo;id&raquo;.jpg    (ic&ocirc;ne du binet)

/doc                (DOSSIER PRÉSENT DANS LA CVS)
    ...             (docs expliquant le fonctionnement du site web)
					
/etc                (DOSSIER PRÉSENT DANS LA CVS)
    httpd.conf      (partie de la configuration générique d'apache)
    frankiz.conf    (partie de la configuration d'apache spécifique à frankiz)
    binets.conf     (partie de la configuration d'apache spécifique aux binets)

/public_html        (DOSSIER PRÉSENT DANS LA CVS)
    /admin          (pages d'administration)
    /gestion        (pages d'administration à destination des élèves : modification des
					paramètre de son binet, de son site web&hellip;)
    annonces.php
	trombino.php
	binets.php
	faq.php
	docs.php        (pages de docs/références récupérées sur le web)
    xshare.php      (pages de la section télécharger)
    index.php
    /include        (fichiers uniquement inclus)
    favicon.ico
    frankiz.dtd
    /modules        (modules)
    /profil         (préférences utilisateur, fiche trombino)
    /skins          (skins)
</pre>
</p>

<p>Pour sauvegarder le site web, il suffit donc de sauvegarder la CVS (qui contient /etc et
/public_html), les bases de données MySQL et le dossier /data. Ce ne serait pas aussi simple
si par exemple les images ou les fichiers de cache étaient stockées dans le /public_html.</p>

<h2 id="droits">Gestions des droits</h2>
<p>L'accès à la gestion des différentes parties du site est soumise à des restrictions. Voici la liste des 
différents droits possibles pour un utilisateur</p>
<ul>
	<li><em>admin</em>: L'utilisateur a tous les droits sur le site, plus spécialement celui de se connecter en tant qu'un autre utilisateur (su), de gérer les ip et d'envoyer les mails promo.</li>
	<li><em>web</em>: L'utilisateur a les droits sur la gestion des annonces et des sondages. Il peut aussi valider ou modifier toutes les affiches (activités) et les faire apparaitre à l'extérieur.</li>
	<li><em>trombino</em>: L'utilisateur a le droit de modifier et de valider les changements relatifs au trombino.</li>
	<li><em>faq</em>: L'utilisateur peut modifier la FAQ.</li>
	<li><em>xshare</em>: L'utilisateur peut gerer la partie Xshare.</li>
	<li><em>qdjmaster</em>: L'utilisateur peut valider les qdj et les planifier.</li>
	<li><em>affiches</em>: L'utilisateur peut valider ou modifier ses propres affiches (activités) mais ne peut pas les faire apparaitre à l'extérieur. Ce droit peut être utilisé pour certains binets ayant des activités régulières, pour ne pas surcharger le travail des utilisateurs web.</li>
	<li><em>webmestre_</em>nomdubinet: L'utilisateur est webmaster du binet "nomdubinet" et peut modifier le site du binet ainsi que sa description dans la page d'acceuil des binets.</li>
	<li><em>prez_</em>nomdubinet: L'utilisateur est président du binet "nomdubinet" et peut modifier la liste des membres de son binet ainsi que leurs commentaires.</li>
	<li><em>bob</em>: L'utilisateur peut définir si le bob est ouvert ou non.</li>
</ul>

</body>
</html>
